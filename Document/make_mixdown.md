# プログラムドキュメント: `make_mixdown.py`

## 1. 概要

本プログラム `make_mixdown.py` は、音声強調やノイズ除去といった機械学習モデルの学習データを生成するためのツールです。クリーンな音声ファイルとノイズファイルを、指定された
**SNR**で混合し、新しい混合音声ファイルを作成します。

---

## 2. 機能仕様

#### 2.1. 主な機能

- 指定されたディレクトリ内の全ての音声ファイルに対して、混合処理を自動で行います。
- 各音声ファイルに対し、ノイズファイルをランダムに選択してペアリングします。
- 音声の長さに合わせてノイズを自動で切り出す。長さが足りない場合はノイズをループさせて使用します。
- 混合する際のSNR(dB)を任意に設定できます。
- 処理の進捗状況がプログレスバーで表示されます。

#### 2.2. 入力

- **音声ファイルディレクトリ (`speech_dir`)**: 処理対象となるクリーンな音声ファイル（WAV形式）が格納されたディレクトリ。
- **ノイズファイルディレクトリ (`noise_dir`)**: 混合に使用するノイズファイル（WAV形式）が格納されたディレクトリ、または単一のノイズファイルへのパス。
- **出力ディレクトリ (`out_dir`)**: 生成された混合音声ファイルを保存するディレクトリ。存在しない場合は自動で作成されます。
- **SNR (`snr`)**: 混合時の信号対雑音比をデシベル(dB)で指定します。

#### 2.3. 出力

- **混合音声ファイル**: 混合処理を経て生成されたWAVファイル。
- **ファイル命名規則**: 出力されるファイルは、以下のルールで命名されます。
  `{元の音声ファイル名}_{使用したノイズファイル名}_{SNR値}dB.wav`
  （例: `speech1_noise_cafe_005dB.wav`）

#### 2.4. 処理フロー

1. `speech_dir` と `noise_dir` からファイルリストを取得します。
2. 各音声ファイルに対して、`noise_dir` 内のノイズファイルをランダムに1つ選択します。
3. 音声ファイルと選択されたノイズファイルを読み込みます。
4. ノイズの波形を、音声の波形と同じ長さになるようにランダムに切り出します（`random_crop`関数）。
5. 音声と切り出したノイズを、指定されたSNRになるように音量を調整して混合します（`mix_snr`関数）。
6. 生成された混合音声を、指定の命名規則で `out_dir` に保存します。
7. `speech_dir` 内の全てのファイルに対して上記処理を繰り返します。

---

## 3. 主要な関数とモジュール

#### 3.1. 主要関数

- `main(speech_dir, noise_dir, out_dir, snr)`: 全体の処理フローを管理するメイン関数。
- `mix_snr(speech, noise, snr_db)`: 音声とノイズを指定のSNRで混合するコア関数。
- `random_crop(noise, target_length)`: ノイズ波形を目標の長さにランダムに切り出す関数。
- `load_wav(filepath)` / `save_wav(filepath, data, sr)`: `soundfile`ライブラリを使用したWAVファイルの読み込み/保存を行うラッパー関数。

#### 3.2. 外部依存モジュール

- **numpy**: 波形データの数値計算に使用。
- **soundfile**: WAVファイルの読み込みと書き込みに使用。
- **tqdm**: 処理の進捗を示すプログレスバーの表示に使用。

---

## 4. 実行方法

#### 4.1. 準備

1. 必要な外部ライブラリをインストールします。
   ```bash
   pip install numpy soundfile tqdm
   ```
2. `mymodule`（`my_func.py`, `const.py`）が同じディレクトリ、またはPythonが認識できるパスに配置されていることを確認します。

#### 4.2. 設定

スクリプト下部の `if __name__ == '__main__':` ブロック内にあるパス変数を、ご自身の環境に合わせて編集します。

#### 4.3. 実行

設定完了後、ターミナルで以下のコマンドを実行します。

```bash
python make_mixdown.py