# Trainerクラス 要件定義書

## 1. 概要

本ドキュメントは、音声強調モデルの「学習」「推論」「客観評価」のプロセスを統一的に管理し、実験の再現性と効率性を向上させるための
`Trainer`クラスの要件を定義する。

## 2. 背景と目的

現在、学習、推論、評価のコードが個別に実装されており、以下の課題が存在する。

- 実験ごとにコードの再利用が難しく、冗長な記述が増える。
- 学習の進捗管理、モデルのチェックポイント管理、評価指標の記録が煩雑。
- 実験設定がコード内にハードコーディングされがちで、再現性の確保が難しい。
- githubでクローンしたモデルが動かない

これらの課題を解決するため、責務を明確に分離した`Trainer`
クラスを実装する。これにより、開発者はモデルの構造やデータセットの準備に集中でき、学習から評価までのパイプラインを容易に実行できるようになることを目的とする。
また，他で拾ってきた音源強調用モデルを動かす際に、モデルとデータローダーの実装だけで学習から評価ができるようなプログラムを目指す

## 3. クラス設計

### 3.1. クラス名

`EnhancementTrainer`

### 3.2. 初期化 (`__init__`)

`Trainer`クラスは、インスタンス化の際にモデル、オプティマイザ、損失関数、データローダー、および各種設定を受け取る。内部で
`config`からモデルが扱うデータドメイン（時間領域 or 周波数領域）を読み込み、以降の処理を制御する。

#### 引数

| 引数名            | 型                                       | 説明                                              |
|----------------|-----------------------------------------|-------------------------------------------------|
| `model`        | `torch.nn.Module`                       | 学習・評価対象のPyTorchモデル。                             |
| `criterion`    | `torch.nn.Module`                       | 損失関数 (例: `torch.nn.MSELoss`)。                   |
| `optimizer`    | `torch.optim.Optimizer`                 | オプティマイザ (例: `torch.optim.Adam`)。                |
| `train_loader` | `torch.utils.data.DataLoader`           | 学習用データローダー。**時間領域の音声波形ペア**（ノイズあり、クリーン）を返すことを想定。 |
| `val_loader`   | `torch.utils.data.DataLoader`           | 検証用データローダー。**時間領域の音声波形ペア**（ノイズあり、クリーン）を返すことを想定。 |
| `config`       | `dict` or `argparse.Namespace`          | 学習と評価に関する設定を格納したオブジェクト。詳細は「4. 設定項目」を参照。         |
| `device`       | `torch.device`                          | 計算に使用するデバイス (`'cpu'` or `'cuda'`)。              |
| `scheduler`    | `torch.optim.lr_scheduler._LRScheduler` | (Optional) 学習率スケジューラ。デフォルトは`None`。              |

### 3.3. 主要メソッド

#### 3.3.1. `train()`

学習ループ全体を管理する。

- **処理概要:**
	1. 指定されたエポック数だけ学習ループを繰り返す。
	2. 各エポックの開始時に、`_train_epoch()`を呼び出して1エポック分の学習を実行する。
	3. 各エポックの終了時に、`_validate_epoch()`を呼び出して検証データでの評価を実行する。
	4. 学習率スケジューラが設定されている場合、適切なタイミングで更新する。
	5. 検証結果に基づき、最良モデルのチェックポイントを保存する。
	6. 定期的に（またはエポック終了時に）最新のチェックポイントを保存する。
	7. TensorBoard等へのログ出力を実行する。

#### 3.3.2. `predict(test_loader, output_dir)`

推論を実行し、強調された音声ファイルを保存する。

- **引数:**
	- `test_loader` (`torch.utils.data.DataLoader`): 推論用データローダー。**時間領域の音声波形**とファイル名を返すことを想定。
	- `output_dir` (`str`): 強調後の音声ファイルを保存するディレクトリパス。
- **処理概要:**
	1. `model.eval()`モードに設定する。
	2. `torch.no_grad()`コンテキストで推論を実行する。
	3. `test_loader`からノイズ付き音声波形とファイル名を取得する。
	4. **モデルのドメインに応じて**、モデルへの入力データを準備する。
		- **周波数領域モデルの場合:** 音声波形をSTFTで複素スペクトログラムに変換する。
		- **時間領域モデルの場合:** 音声波形をそのまま使用する。
	5. 準備したデータをモデルに入力し、強調後のデータ（スペクトログラム or 波形）を得る。
	6. **モデルの出力が周波数領域の場合**、ISTFTで音声波形に逆変換する。この際、元のノイズ付き音声の位相情報を使用する。
	7. 出力音声を正規化し，int16の最大値を掛ける
	8. 最終的に得られた音声波形を、指定された`output_dir`に元のファイル名で保存する。

#### 3.3.3. `evaluate(eval_loader)`

指定されたデータセットを用いて客観評価指標を計算する。

- **引数:**
	- `eval_loader` (`torch.utils.data.DataLoader`): 評価用データローダー。**時間領域の音声波形ペア**
	  （音源強調後の信号、教師データ）と各ファイルパス（絶対パス）を返すことを想定。
	- `output_csv_path` (`str`): 評価結果を保存するcsvファイルのパス。デフォルトは`.\result\{yyyymmddhhmm}.csv`。
- **処理概要:**
	1. `model.eval()`モードに設定する。
	2. `torch.no_grad()`コンテキストで実行する。
	3. `eval_loader`から音源強調後の信号と教師信号と各ファイル名を取得する。
	4. 音源強調後の信号と教師信号の最大振幅をint16の最大値にする
	5. データローダーから得られる強調後の音声波形と、クリーン音声波形を用いて、以下の客観評価指標を計算する。
		- **PESQ** (Perceptual Evaluation of Speech Quality)
		- **STOI** (Short-Time Objective Intelligibility)
		- **SI-SDR** (Scale-Invariant Signal-to-Distortion Ratio)
		- 後に増える可能性あり
	6. 各指標の計算結果を辞書形式でまとめ、`output_csv_path`にCSV形式で保存する。
	   csvのカラムには以下の要素を含む
		- target_path: 教師信号のパス
		- estimation_path: 音源強調後の信号のパス
		- pesq: PESQの値
		- STOI: STOIの値
		- SI-SDR: SI-SDRの値
		- 各値の平均と分散
	7. データセット全体での平均スコアを計算し、ターミナルに出力する。

### 3.4. 内部（プライベート）メソッド

- `_train_epoch()`: 1エポック分の学習処理を実装。内部でモデルのドメインに応じたデータ変換を行う。
- `_validate_epoch()`: 1エポック分の検証処理と損失計算を実装。内部でモデルのドメインに応じたデータ変換を行う。
- `_save_checkpoint(epoch, is_best)`: モデルの重み、オプティマイザの状態などを保存。
- `_load_checkpoint(path)`: 指定されたパスからチェックポイントを読み込む。
- `_log_metrics(metrics, step, phase)`: TensorBoard等にメトリクスを記録。

## 4. 設定項目 (`config`)

`Trainer`に渡す設定オブジェクト（辞書など）には、以下のキーが含まれることを想定する：

### 4.1. モデル設定

| キー                      | 型     | 説明                                       | デフォルト値   |
|-------------------------|-------|------------------------------------------|----------|
| `model.domain`          | `str` | モデルが扱うデータドメイン（`'time'` or `'frequency'`） | `'time'` |
| `model.name`            | `str` | モデルの識別名（ログ出力やファイル名に使用）                   | -        |
| `model.checkpoint_path` | `str` | 事前学習済みモデルのパス（ある場合）                       | `None`   |

### 4.2. 学習設定

| キー                        | 型       | 説明                      | デフォルト値       |
|---------------------------|---------|-------------------------|--------------|
| `epochs`                  | `int`   | 学習エポック数                 | `100`        |
| `save_dir`                | `str`   | チェックポイントとログの保存先ディレクトリ   | `'./result'` |
| `sample_rate`             | `int`   | 音声のサンプリングレート            | `16000`      |
| `early_stopping_patience` | `int`   | Early Stopping の待機エポック数 | `10`         |
| `grad_clip_val`           | `float` | 勾配クリッピングの閾値             | `None`       |
| `use_amp`                 | `bool`  | 混合精度学習の使用フラグ            | `False`      |

### 4.3. STFT設定（周波数領域モデルの場合）

| キー                       | 型     | 説明                 | デフォルト値   |
|--------------------------|-------|--------------------|----------|
| `stft_params.n_fft`      | `int` | STFTのフーリエ変換サイズ     | `512`    |
| `stft_params.hop_length` | `int` | STFT のホップ長         | `256`    |
| `stft_params.win_length` | `int` | STFT の窓長           | `512`    |
| `stft_params.window`     | `str` | 窓関数の種類（例：`'hann'`） | `'hann'` |

### 4.4. ログ設定

| キー                    | 型      | 説明                  | デフォルト値 |
|-----------------------|--------|---------------------|--------|
| `log.use_tensorboard` | `bool` | TensorBoard の使用フラグ  | `True` |
| `log.save_interval`   | `int`  | チェックポイントの保存間隔（エポック） | `1`    |
| `log.eval_interval`   | `int`  | 評価の実行間隔（エポック）       | `1`    |

### 4.5. 評価設定

| キー                | 型     | 説明                 | デフォルト値            |
|-------------------|-------|--------------------|-------------------|
| `eval.output_dir` | `str` | 評価結果のCSVの保存先ディレクトリ | `'./RESULT/eval'` |

### 4.6. 最適化設定

| キー                       | 型       | 説明                                 | デフォルト値  |
|--------------------------|---------|------------------------------------|---------|
| `optim.lr`               | `float` | 学習率                                | `0.001` |
| `optim.scheduler`        | `str`   | スケジューラの種類（例：`'reduce_on_plateau'`） | `None`  |
| `optim.scheduler_params` | `dict`  | スケジューラのパラメータ                       | `{}`    |
| `optim.weight_decay`     | `float` | 重み減衰係数                             | `0.0`   |

### 設定例

```json:config.json
{
  "model": {
    "domain": "frequency",
    "name": "unet_stft",
    "checkpoint_path": null
  },
  "epochs": 100,
  "save_dir": "experiments/unet_stft",
  "sample_rate": 16000,
  "early_stopping_patience": 10,
  "stft_params": {
    "n_fft": 512,
    "hop_length": 256,
    "win_length": 512,
    "window": "hann"
  },
  "log": {
    "use_tensorboard": true,
    "save_interval": 1,
    "eval_interval": 1
  },
  "eval": {
    "output_dir": "enhanced"
  },
  "optim": {
    "lr": 0.001,
    "scheduler": "reduce_on_plateau",
    "scheduler_params": {
      "mode": "min",
      "factor": 0.5,
      "patience": 5
    }
  }
}
```

この設定はPythonの辞書として定義され、`Trainer`クラスのインスタンス化時に渡される。また、JSON形式での保存も可能で、実験の再現性を確保できる。

この設定項目は、以下の特徴を持っています：

1. 階層的な構造で整理され、関連する設定がグループ化されています
2. 各設定項目に型情報とデフォルト値が明記されています
3. 必要に応じて拡張可能な柔軟な構造になっています
4. 実用的な設定例が含まれています

