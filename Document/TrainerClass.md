# Trainerクラス 要件定義書

## 1. 概要

本ドキュメントは、音声強調モデルの「学習」「推論」「客観評価」のプロセスを統一的に管理し、実験の再現性と効率性を向上させるための`Trainer`クラスの要件を定義する。

## 2. 背景と目的

現在、学習、推論、評価のコードが個別に実装されており、以下の課題が存在する。

-   実験ごとにコードの再利用が難しく、冗長な記述が増える。
-   学習の進捗管理、モデルのチェックポイント管理、評価指標の記録が煩雑。
-   実験設定がコード内にハードコーディングされがちで、再現性の確保が難しい。

これらの課題を解決するため、責務を明確に分離した`Trainer`クラスを実装する。これにより、開発者はモデルの構造やデータセットの準備に集中でき、学習から評価までのパイプラインを容易に実行できるようになることを目的とする。

## 3. クラス設計

### 3.1. クラス名

`EnhancementTrainer`

### 3.2. 初期化 (`__init__`)

`Trainer`クラスは、インスタンス化の際にモデル、オプティマイザ、損失関数、データローダー、および各種設定を受け取る。内部で`config`からモデルが扱うデータドメイン（時間領域 or 周波数領域）を読み込み、以降の処理を制御する。

#### 引数

| 引数名          | 型                                     | 説明                                                                                             |
| --------------- | -------------------------------------- | ------------------------------------------------------------------------------------------------ |
| `model`         | `torch.nn.Module`                      | 学習・評価対象のPyTorchモデル。                                                                  |
| `criterion`     | `torch.nn.Module`                      | 損失関数 (例: `torch.nn.MSELoss`)。                                                              |
| `optimizer`     | `torch.optim.Optimizer`                | オプティマイザ (例: `torch.optim.Adam`)。                                                        |
| `train_loader`  | `torch.utils.data.DataLoader`          | 学習用データローダー。**時間領域の音声波形ペア**（ノイズあり、クリーン）を返すことを想定。         |
| `val_loader`    | `torch.utils.data.DataLoader`          | 検証用データローダー。**時間領域の音声波形ペア**（ノイズあり、クリーン）を返すことを想定。         |
| `config`        | `dict` or `argparse.Namespace`         | 学習と評価に関する設定を格納したオブジェクト。詳細は「4. 設定項目」を参照。                      |
| `device`        | `torch.device`                         | 計算に使用するデバイス (`'cpu'` or `'cuda'`)。                                                   |
| `scheduler`     | `torch.optim.lr_scheduler._LRScheduler`| (Optional) 学習率スケジューラ。デフォルトは`None`。                                              |

### 3.3. 主要メソッド

#### 3.3.1. `train()`

学習ループ全体を管理する。

-   **処理概要:**
    1.  指定されたエポック数だけ学習ループを繰り返す。
    2.  各エポックの開始時に、`_train_epoch()`を呼び出して1エポック分の学習を実行する。
    3.  各エポックの終了時に、`_validate_epoch()`を呼び出して検証データでの評価を実行する。
    4.  学習率スケジューラが設定されている場合、適切なタイミングで更新する。
    5.  検証結果に基づき、最良モデルのチェックポイントを保存する。
    6.  定期的に（またはエポック終了時に）最新のチェックポイントを保存する。
    7.  TensorBoard等へのログ出力を実行する。

#### 3.3.2. `predict(test_loader, output_dir)`

推論を実行し、強調された音声ファイルを保存する。

-   **引数:**
    -   `test_loader` (`torch.utils.data.DataLoader`): 推論用データローダー。**時間領域の音声波形**とファイル名を返すことを想定。
    -   `output_dir` (`str`): 強調後の音声ファイルを保存するディレクトリパス。
-   **処理概要:**
    1.  `model.eval()`モードに設定する。
    2.  `torch.no_grad()`コンテキストで推論を実行する。
    3.  `test_loader`からノイズ付き音声波形とファイル名を取得する。
    4.  **モデルのドメインに応じて**、モデルへの入力データを準備する。
        -   **周波数領域モデルの場合:** 音声波形をSTFTで複素スペクトログラムに変換する。
        -   **時間領域モデルの場合:** 音声波形をそのまま使用する。
    5.  準備したデータをモデルに入力し、強調後のデータ（スペクトログラム or 波形）を得る。
    6.  **モデルの出力が周波数領域の場合**、ISTFTで音声波形に逆変換する。この際、元のノイズ付き音声の位相情報を使用する。
    7.  最終的に得られた音声波形を、指定された`output_dir`に元のファイル名で保存する。

#### 3.3.3. `evaluate(eval_loader)`

指定されたデータセットを用いて客観評価指標を計算する。

-   **引数:**
    -   `eval_loader` (`torch.utils.data.DataLoader`): 評価用データローダー。**時間領域の音声波形ペア**（ノイズあり、クリーン）を返すことを想定。
-   **処理概要:**
    1.  `model.eval()`モードに設定する。
    2.  `torch.no_grad()`コンテキストで実行する。
    3.  `eval_loader`からノイズ付き波形とクリーン波形を取得する。
    4.  `predict`メソッドと同様の手順で、ノイズ付き波形から**強調後の音声波形**を生成する。
    5.  生成された強調後の音声波形と、データローダーから得られるクリーン音声波形を用いて、以下の客観評価指標を計算する。
        -   **PESQ** (Perceptual Evaluation of Speech Quality)
        -   **STOI** (Short-Time Objective Intelligibility)
        -   **SI-SDR** (Scale-Invariant Signal-to-Distortion Ratio)
    6.  データセット全体での平均スコアを計算し、辞書形式で返す。

### 3.4. 内部（プライベート）メソッド

-   `_train_epoch()`: 1エポック分の学習処理を実装。内部でモデルのドメインに応じたデータ変換を行う。
-   `_validate_epoch()`: 1エポック分の検証処理と損失計算を実装。内部でモデルのドメインに応じたデータ変換を行う。
-   `_save_checkpoint(epoch, is_best)`: モデルの重み、オプティマイザの状態などを保存。
-   `_load_checkpoint(path)`: 指定されたパスからチェックポイントを読み込む。
-   `_log_metrics(metrics, step, phase)`: TensorBoard等にメトリクスを記録。

## 4. 設定項目 (`config`)

`Trainer`に渡す設定オブジェクト（辞書など）には、以下のキーが含まれることを想定する。

